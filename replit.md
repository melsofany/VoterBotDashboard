# نظام إدارة بيانات الناخبين - حملة المرشح علاء سليمان الحديوي

## نظرة عامة
نظام متكامل يتكون من:
1. **بوت تيليجرام** لجمع بيانات الناخبين من المندوبين الميدانيين
2. **لوحة تحكم ويب** لعرض وتحليل البيانات

## البنية التقنية

### Frontend (React + TypeScript)
- **الصفحات**:
  - `/` - لوحة التحكم الرئيسية مع الإحصائيات والرسوم البيانية
  - `/voters` - قائمة الناخبين مع البحث والتفاصيل
  - `/representatives` - إدارة المناديب وأدائهم
  - `/analytics` - تحليلات متقدمة

- **المكونات الرئيسية**:
  - `DashboardLayout` - التخطيط الأساسي مع التنقل
  - جميع المكونات تدعم اللغة العربية (RTL)

### Backend (Node.js + Express)
- **Telegram Bot**: جمع البيانات من المندوبين
- **API Routes**: نقاط نهاية للواجهة الأمامية
- **Google Sheets Integration**: حفظ البيانات
- **Google Drive Integration**: رفع صور البطاقات
- **OCR Integration**: استخراج البيانات من صور البطاقات
- **Egyptian ID Decoder**: فك تشفير الرقم القومي لاستخراج تاريخ الميلاد والمحافظة والجنس
- **Age Calculator**: حساب العمر وتحديد كبار السن (60+)

## تدفق عمل البوت

### الطريقة الأولى: التطبيق المصغر (Mini App) - موصى بها ⭐
1. **التحقق من الهوية**: المندوب يرسل /start، البوت يتحقق من معرّفه
2. **فتح التطبيق المصغر**: الضغط على زر "📱 فتح الكاميرا الذكية"
3. **الكاميرا الذكية المُحسّنة**: 
   - يفتح التطبيق المصغر مع كاميرا مباشرة **بسرعة عالية** (دقة 720p محسّنة)
   - إطار توجيهي ذكي مُعاير لحجم البطاقة المصرية (نسبة 1.57:1)
   - **كشف ذكي للحواف** - كل حافة (علوي، أيمن، سفلي، أيسر) تتحول للأخضر بشكل منفصل
   - مؤشرات بصرية واضحة لحالة كل حافة
   - كشف تلقائي لجودة الصورة (الإضاءة والوضوح)
   - **التقاط تلقائي فوري** عندما تكون جميع الحواف خضراء والصورة واضحة
4. **OCR فوري**: استخراج البيانات مباشرة من الصورة
5. **عرض النتائج**: الرقم القومي، الاسم، العنوان
6. **إكمال البيانات**: الموقع، العائلة، رقم الهاتف، الموقف السياسي
7. **الحفظ**: رفع الصورة لـ Drive وحفظ البيانات في Sheets

#### التحسينات الأخيرة (25 أكتوبر 2025):
- ⚡ **تحسين السرعة**: تقليل دقة الكاميرا من 1080p إلى 720p لفتح أسرع للتطبيق
- 📐 **إطار محسّن**: تعديل أبعاد الإطار لتناسب البطاقة المصرية بدقة
- 🎯 **كشف الحواف الذكي**: كل حافة تُكتشف وتتحول للأخضر بشكل مستقل
- 🚀 **استجابة أسرع**: تقليل فترة الفحص من 500ms إلى 300ms

### الطريقة الثانية: رفع صورة عادية
1. **التحقق من الهوية**: المندوب يرسل /start
2. **اختيار**: الضغط على "🖼️ إرسال صورة عادية"
3. **رفع الصورة**: المندوب يرسل صورة البطاقة
4. **OCR**: استخراج تلقائي للرقم القومي والاسم
5. **الموقع**: مشاركة موقع الناخب
6. **المعلومات الإضافية**: اسم العائلة، رقم الهاتف
7. **الموقف السياسي**: مؤيد/معارض/محايد
8. **الحفظ**: رفع الصورة لـ Drive وحفظ البيانات في Sheets

## نموذج البيانات

### Voters (الناخبون)
- id, nationalId, fullName, familyName, phoneNumber
- latitude, longitude (الموقع)
- stance (الموقف: supporter/opponent/neutral)
- idCardImageUrl (رابط صورة البطاقة)
- representativeId, representativeName
- createdAt

**ملاحظة:** يتم استخراج تاريخ الميلاد والجنس والمحافظة تلقائياً من الرقم القومي

### Representatives (المناديب)
- userId (معرّف التيليجرام)
- name (اختياري)
- totalVoters, lastActiveAt
- إحصائيات كبار السن (60+) لكل مندوب
- توزيع الجنس (ذكور/إناث)

## المتغيرات البيئية المطلوبة

```
TELEGRAM_BOT_TOKEN=...        # مطلوب
GOOGLE_SHEET_ID=...          # مطلوب
GOOGLE_DRIVE_FOLDER_ID=...   # مطلوب
ADMIN_USERNAME=...           # مطلوب
ADMIN_PASSWORD=...           # مطلوب
HUGGINGFACE_TOKEN=...        # اختياري - لكن موصى به لتحسين OCR
```

**جميع هذه المتغيرات موجودة الآن في Replit Secrets**

### كيفية الحصول على HUGGINGFACE_TOKEN (اختياري)
لتحسين دقة استخراج البيانات من البطاقات:
1. سجل حساب مجاني في [Hugging Face](https://huggingface.co/join)
2. اذهب إلى [Settings > Access Tokens](https://huggingface.co/settings/tokens)
3. أنشئ token جديد (Read permissions كافية)
4. أضفه إلى Replit Secrets باسم `HUGGINGFACE_TOKEN`

**ملاحظة:** بدون Token، سيستخدم النظام Tesseract فقط (ما زال مجانياً ويعمل جيداً!)

## إعداد Google Sheets

### خطوات الإعداد:

1. **إنشاء Google Sheet جديد**:
   - افتح https://sheets.google.com
   - أنشئ ملف جديد (Blank Spreadsheet)
   - انسخ الـ ID من الرابط (الجزء بين /d/ و /edit)
   - أضفه في متغير البيئة GOOGLE_SHEET_ID

2. **مشاركة الملف**:
   - اضغط على "Share" في الزاوية اليمنى
   - تأكد أن الملف "Anyone with the link can view"
   - أو قم بمشاركته مع الحساب المستخدم في Google Sheets Integration

3. **إضافة معرفات المناديب**:
   - البوت سيقوم تلقائياً بإنشاء ورقتين: "Voters" و "Representatives"
   - بعد التشغيل الأول، افتح ورقة "Representatives"
   - أضف معرفات المناديب بهذا الشكل:

### ورقة "Representatives"
| user_id   | name        |
|-----------|-------------|
| 123456789 | أحمد محمد   |
| 987654321 | محمود علي   |

**ملاحظة**: لمعرفة User ID الخاص بك في تيليجرام، أرسل رسالة لـ @userinfobot

### ورقة "Voters"
يتم ملؤها تلقائياً من البوت (لا تقم بتعديلها يدوياً)

## التشغيل

التطبيق يعمل الآن تلقائياً عند فتح المشروع في Replit.

### الوصول للوحة التحكم
1. افتح الرابط الظاهر في نافذة Webview
2. ستظهر صفحة تسجيل الدخول
3. أدخل `ADMIN_USERNAME` و `ADMIN_PASSWORD` المحفوظين في Secrets
4. بعد تسجيل الدخول، يمكنك الوصول لجميع صفحات لوحة التحكم

### إدارة المناديب من لوحة التحكم
1. انتقل إلى صفحة "المناديب"
2. اضغط على "إضافة مندوب"
3. أدخل User ID الخاص بالمندوب (من @userinfobot)
4. أدخل اسم المندوب (اختياري)
5. يمكنك تعديل أو حذف المناديب في أي وقت

## الميزات الرئيسية

### لوحة التحكم
- ✅ **تسجيل دخول آمن** (اسم مستخدم وكلمة مرور)
- ✅ إحصائيات شاملة (إجمالي، مؤيد، معارض، محايد)
- ✅ **إحصائيات كبار السن (60+)** مع توزيع الجنس وحساب السيارات المطلوبة
- ✅ **توزيع الجنس** (ذكور/إناث) للناخبين
- ✅ رسوم بيانية تفاعلية
- ✅ قائمة ناخبين مع بحث متقدم
- ✅ تفاصيل كل ناخب مع الصورة والموقع
- ✅ **إدارة المناديب** (إضافة، تعديل، حذف)
- ✅ إحصائيات المناديب مع بيانات كبار السن لكل مندوب
- ✅ تحليلات حسب العائلات
- ✅ دعم كامل للغة العربية (RTL)

### بوت التيليجرام
- ✅ تحقق أمني من هوية المندوبين
- ✅ **استخراج ذكي للبيانات من البطاقات (OCR محسّن)**
  - 🤖 نماذج ذكاء اصطناعي مجانية من Hugging Face
  - 📸 معالجة الصور بـ 3 طرق مختلفة للحصول على أفضل نتيجة
  - 🇪🇬 دعم كامل للعربية والأرقام الهندية (٠-٩)
  - 🔍 استخراج: الاسم + الرقم القومي + العنوان + المحافظة
  - ✨ دقة 80-95% حسب جودة الصورة
- ✅ **فك تشفير ذكي للرقم القومي** (ميزة جديدة!)
  - 📅 استخراج تاريخ الميلاد تلقائياً من الرقم القومي
  - 📍 تحديد المحافظة من كود المحافظة في الرقم القومي
  - 👤 معرفة النوع (ذكر/أنثى) من آخر رقم في الرقم القومي
  - ✨ يعمل بدون الحاجة لقراءة هذه البيانات من البطاقة
- ✅ التحقق من صحة البيانات
- ✅ رفع تلقائي للصور على Drive (خاص ومحمي)
- ✅ حفظ فوري في Sheets
- ✅ واجهة سهلة وسلسة

## الأمان والخصوصية

### حماية البيانات
- 🔒 **صور البطاقات خاصة**: جميع صور بطاقات الناخبين يتم رفعها على Google Drive بصلاحيات خاصة فقط
- 🛡️ **لا روابط عامة**: لا يمكن لأي شخص الوصول للصور بدون تسجيل دخول للحساب المصرح
- ✅ **التحقق من المناديب**: فقط المناديب المسجلين في Google Sheets يمكنهم استخدام البوت
- 📊 **بيانات محمية**: جميع البيانات محفوظة في Google Sheets بصلاحيات محددة

### ملاحظات أمنية مهمة
1. **لا تشارك روابط Drive**: روابط الصور في Google Sheets خاصة ولن تعمل إلا لمن لديه صلاحيات
2. **إدارة الصلاحيات**: تأكد من أن Google Drive Folder و Google Sheet لهما صلاحيات محددة فقط
3. **معرفات المناديب**: احذف أي مندوب غير نشط من ورقة Representatives فوراً

## التصميم

- نظام Material Design
- خط Cairo للعربية
- دعم وضع داكن/فاتح تلقائي
- تجاوب كامل مع جميع الأجهزة
- تنقل سفلي للموبايل، جانبي للديسكتوب
